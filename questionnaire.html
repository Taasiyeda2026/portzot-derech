<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>×©××œ×•×Ÿ ×–×™×•×•×’ | ×¤×•×¨×¦×•×ª ×“×¨×š</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #000000;
      color: #ffffff;
      min-height: 100vh;
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 20px;
      overflow-x: hidden;
    }
    
    /* ×× ×™××¦×™×™×ª ×¨×§×¢ ××–×•×”×¨×ª */
    body::before {
      content: '';
      position: fixed;
      top: -50%;
      left: -50%;
      width: 200%;
      height: 200%;
      background: 
        radial-gradient(circle at 20% 50%, rgba(255, 0, 127, 0.15) 0%, transparent 50%),
        radial-gradient(circle at 80% 80%, rgba(255, 20, 147, 0.1) 0%, transparent 50%),
        radial-gradient(circle at 40% 20%, rgba(199, 21, 133, 0.1) 0%, transparent 50%);
      animation: glow 15s ease-in-out infinite;
      pointer-events: none;
      z-index: 0;
    }
    
    @keyframes glow {
      0%, 100% { transform: translate(0, 0) scale(1); }
      50% { transform: translate(5%, 5%) scale(1.1); }
    }
    
    .container {
      position: relative;
      z-index: 1;
      max-width: 700px;
      width: 100%;
      margin-top: 40px;
    }
    
    /* ×¤×¡ ×”×ª×§×“××•×ª */
    .progress-bar-container {
      background: rgba(255, 255, 255, 0.1);
      height: 6px;
      border-radius: 3px;
      margin-bottom: 32px;
      overflow: hidden;
    }
    
    .progress-bar {
      height: 100%;
      background: linear-gradient(90deg, #ff1493, #ff69b4);
      border-radius: 3px;
      width: 0%;
      transition: width 0.5s ease;
      box-shadow: 0 0 15px rgba(255, 20, 147, 0.6);
    }
    
    .progress-text {
      text-align: center;
      margin-bottom: 12px;
      font-size: 14px;
      color: rgba(255, 255, 255, 0.7);
    }
    
    /* ×›×¨×˜×™×¡ ×©××œ×” */
    .card {
      background: rgba(30, 30, 35, 0.95);
      backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 42px 38px;
      box-shadow: 
        0 8px 32px rgba(0, 0, 0, 0.5),
        0 0 60px rgba(255, 20, 147, 0.2);
      border: 1px solid rgba(255, 20, 147, 0.3);
      margin-bottom: 20px;
      animation: slideIn 0.5s ease;
    }
    
    @keyframes slideIn {
      from {
        opacity: 0;
        transform: translateY(30px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
    
    .card.hidden {
      display: none;
    }
    
    h2 {
      font-size: 26px;
      font-weight: 700;
      margin-bottom: 24px;
      background: linear-gradient(135deg, #ff1493, #ff69b4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    label {
      display: block;
      margin: 20px 0 12px 0;
      font-weight: 600;
      color: rgba(255, 255, 255, 0.9);
      font-size: 16px;
      line-height: 1.5;
    }
    
    /* ×©×“×” ×§×œ×˜ ×˜×§×¡×˜ */
    input[type="text"] {
      width: 100%;
      padding: 16px;
      font-size: 16px;
      background: rgba(0, 0, 0, 0.4);
      border: 2px solid rgba(255, 20, 147, 0.3);
      border-radius: 12px;
      color: #ffffff;
      transition: all 0.3s ease;
      margin-bottom: 12px;
    }
    
    input[type="text"]:focus {
      outline: none;
      border-color: #ff1493;
      box-shadow: 0 0 20px rgba(255, 20, 147, 0.3);
    }
    
    input::placeholder {
      color: rgba(255, 255, 255, 0.4);
    }
    
    /* ×§×‘×•×¦×ª ×‘×—×™×¨×•×ª */
    .choice-group {
      display: flex;
      flex-direction: column;
      gap: 10px;
      margin-bottom: 16px;
    }
    
    .choice {
      padding: 16px 20px;
      background: rgba(0, 0, 0, 0.3);
      border: 2px solid rgba(255, 255, 255, 0.1);
      border-radius: 12px;
      cursor: pointer;
      transition: all 0.3s ease;
      font-size: 15px;
      line-height: 1.5;
    }
    
    .choice:hover {
      background: rgba(255, 20, 147, 0.1);
      border-color: rgba(255, 20, 147, 0.4);
      transform: translateX(-3px);
    }
    
    .choice.selected {
      background: rgba(255, 20, 147, 0.2);
      border-color: #ff1493;
      box-shadow: 0 0 20px rgba(255, 20, 147, 0.3);
      font-weight: 600;
    }
    
    /* ×›×¤×ª×•×¨×™× */
    button.primary {
      width: 100%;
      padding: 18px;
      margin-top: 24px;
      font-size: 18px;
      font-weight: 700;
      background: linear-gradient(135deg, #ff1493, #ff69b4);
      color: white;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      transition: all 0.3s ease;
      box-shadow: 0 6px 20px rgba(255, 20, 147, 0.4);
    }
    
    button.primary:hover {
      transform: translateY(-3px);
      box-shadow: 0 8px 25px rgba(255, 20, 147, 0.6);
    }
    
    button.primary:active {
      transform: translateY(-1px);
    }
    
    button.primary:disabled {
      opacity: 0.5;
      cursor: not-allowed;
    }
    
    /* ××¡×š ×”××ª× ×” */
    .waiting-screen {
      text-align: center;
      padding: 60px 40px;
    }
    
    .waiting-screen h2 {
      font-size: 32px;
      margin-bottom: 20px;
    }
    
    .waiting-screen p {
      font-size: 18px;
      line-height: 1.8;
      color: rgba(255, 255, 255, 0.8);
      margin-bottom: 16px;
    }
    
    .spinner {
      width: 60px;
      height: 60px;
      border: 4px solid rgba(255, 20, 147, 0.2);
      border-top-color: #ff1493;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin: 32px auto;
    }
    
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    
    /* ××¡×š ×ª×•×¦××•×ª */
    .results-screen h2 {
      margin-bottom: 28px;
    }
    
    .partner-card {
      background: rgba(255, 20, 147, 0.1);
      border: 2px solid rgba(255, 20, 147, 0.3);
      border-radius: 16px;
      padding: 24px;
      margin-bottom: 20px;
    }
    
    .partner-name {
      font-size: 24px;
      font-weight: 700;
      color: #ff69b4;
      margin-bottom: 12px;
    }
    
    .match-score {
      font-size: 18px;
      color: rgba(255, 255, 255, 0.9);
      margin-bottom: 16px;
    }
    
    .match-reasons {
      list-style: none;
      padding: 0;
    }
    
    .match-reasons li {
      padding: 8px 0;
      padding-right: 24px;
      position: relative;
      color: rgba(255, 255, 255, 0.8);
      font-size: 15px;
    }
    
    .match-reasons li:before {
      content: 'âœ“';
      position: absolute;
      right: 0;
      color: #ff69b4;
      font-weight: bold;
    }
    
    @media (max-width: 768px) {
      .card {
        padding: 32px 24px;
      }
      
      h2 {
        font-size: 22px;
      }
      
      label {
        font-size: 15px;
      }
      
      .choice {
        padding: 14px 16px;
        font-size: 14px;
      }
    }
  </style>
</head>

<body>

  <div class="container">
    
    <!-- ×¤×¡ ×”×ª×§×“××•×ª -->
    <div class="progress-text" id="progressText">×©×œ×‘ 1 ××ª×•×š 5</div>
    <div class="progress-bar-container">
      <div class="progress-bar" id="progressBar"></div>
    </div>
    
    <!-- ×©×œ×‘ 1 -->
    <div class="card" id="step1">
      <h2>×œ×¤× ×™ ×©××ª×—×™×œ×•×ª</h2>
      <label>×©× ×¤×¨×˜×™ / ×›×™× ×•×™ (×›×“×™ ×©×ª×•×›×œ×™ ×œ×–×”×•×ª ××ª ×¢×¦××š ×‘××¡×š ×”×—×™×‘×•×¨×™×)</label>
      <input type="text" id="displayName" placeholder="×œ×“×•×’××”: × ×•×¢×”" maxlength="24">

      <h2 style="margin-top:24px">×ª×—×•××™ ×¢× ×™×™×Ÿ</h2>
      <label>××” ×”×ª×—×•× ×”××¨×›×–×™ ×©×‘×—×¨×ª ×œ×ª×”×œ×™×š?</label>
      <div class="choice-group" data-field="mainDomain">
        <div class="choice">×”×™×™×˜×§ ×•×œ×™×‘×”</div>
        <div class="choice">××“× ×•×˜×›× ×•×œ×•×’×™×”</div>
        <div class="choice">×¡×‘×™×‘×” ×•×§×™×™××•×ª</div>
        <div class="choice">×¢×ª×™×“ ×•×™×–××•×ª</div>
        <div class="choice">×—×‘×¨×” ×•×“×™×’×™×˜×œ</div>
      </div>

      <label>×”×× ×™×© ×ª×—×•× × ×•×¡×£ ×©××¢× ×™×™×Ÿ ××•×ª×š?</label>
      <div class="choice-group" data-field="secondDomain">
        <div class="choice">×”×™×™×˜×§ ×•×œ×™×‘×”</div>
        <div class="choice">××“× ×•×˜×›× ×•×œ×•×’×™×”</div>
        <div class="choice">×¡×‘×™×‘×” ×•×§×™×™××•×ª</div>
        <div class="choice">×¢×ª×™×“ ×•×™×–××•×ª</div>
        <div class="choice">×—×‘×¨×” ×•×“×™×’×™×˜×œ</div>
        <div class="choice">×× ×™ ××¢×“×™×¤×” ×œ×”×ª××§×“ ×‘×ª×—×•× ××—×“</div>
      </div>

      <button class="primary" type="button" onclick="next(2)">×”××©×š</button>
    </div>

    <!-- ×©×œ×‘ 2 -->
    <div class="card hidden" id="step2">
      <h2>××™×š ××ª ×¤×•×¢×œ×ª?</h2>
      
      <label>×›×©×™×© ××©×™××” ×—×“×©×” ×•×œ× ×‘×¨×•×¨×”, ××ª ×‘×“×¨×š ×›×œ×œ:</label>
      <div class="choice-group" data-field="workStyle">
        <div class="choice">××ª×—×™×œ×” ×œ×”×ª× ×¡×•×ª ×•×œ×•××“×ª ×ª×•×š ×›×“×™ ×”×ª× ×¡×•×ª</div>
        <div class="choice">×¢×•×¦×¨×ª ×§×•×“× ×œ×”×‘×™×Ÿ ×œ×¢×•××§ ×•×œ×ª×›× ×Ÿ ××ª ×”×¦×¢×“×™×</div>
      </div>

      <label>×›×©××ª ×¢×•×‘×“×ª ×¢× ×©×•×ª×¤×” ×¢×œ ××©×™××”:</label>
      <div class="choice-group" data-field="teamStyle">
        <div class="choice">×× ×™ ×—×•×©×‘×ª ×‘×§×•×œ ×¨× ×•××©×ª×¤×ª ×›×œ ×¨×¢×™×•×Ÿ</div>
        <div class="choice">×× ×™ ××¢×“×™×¤×” ×œ×¢×‘×•×“ ×‘×©×§×˜ ×•××– ×œ×”×¦×™×’ ××ª ×”×ª×•×¦××”</div>
      </div>

      <label>××”×• ×§×¦×‘ ×”×¢×‘×•×“×” ×”×˜×‘×¢×™ ×©×œ×š?</label>
      <div class="choice-group" data-field="workPace">
        <div class="choice">×× ×™ ××•×”×‘×ª ×œ×¢×‘×•×“ ××”×¨ ×•×œ×¡×™×™× ××•×§×“×</div>
        <div class="choice">×× ×™ ××¢×“×™×¤×” ×œ×§×—×ª ×–××Ÿ ×•×œ×¢×©×•×ª ×‘×“×™×•×§</div>
        <div class="choice">×ª×œ×•×™ ×‘××©×™××” - ×× ×™ ×’××™×©×”</div>
      </div>

      <button class="primary" type="button" onclick="next(3)">×”××©×š</button>
    </div>

    <!-- ×©×œ×‘ 3 -->
    <div class="card hidden" id="step3">
      <h2>×”×ª×¤×§×™×“ ×©×œ×š ×‘×¦×•×•×ª</h2>

      <label>×‘××™×–×” ×ª×¤×§×™×“ ××ª ×”×›×™ ×˜×•×‘×” ×‘×¢×‘×•×“×ª ×¦×•×•×ª?</label>
      <div class="choice-group" data-field="teamRole">
        <div class="choice">×œ××¦×•× ×¨×¢×™×•× ×•×ª ××§×•×¨×™×™× ×•×œ×”×ª×—×™×œ ×“×‘×¨×™× ×—×“×©×™×</div>
        <div class="choice">×œ××¨×’×Ÿ ××©×™××•×ª ×•×œ×•×•×“× ×©×”×›×œ ×–×•×¨× ×‘×–××Ÿ</div>
        <div class="choice">×œ×¢×–×•×¨ ×œ××—×¨×•×ª ×œ×”×‘×™×Ÿ ×•×œ×”×¡×‘×™×¨ ××•×©×’×™× ××•×¨×›×‘×™×</div>
        <div class="choice">×œ×¤×ª×•×¨ ×‘×¢×™×•×ª ×˜×›× ×™×•×ª ×›×©××©×”×• ×ª×§×•×¢</div>
      </div>

      <label>××” ×¢×•×–×¨ ×œ×š ×œ×”×ª××™×“ ×‘×¤×¨×•×™×§×˜ ×œ××•×¨×š ×–××Ÿ?</label>
      <div class="choice-group" data-field="motivationSource">
        <div class="choice">×ª×—×•×©×ª ××©××¢×•×ª - ×©×× ×™ ×¢×•×©×” ××©×”×• ×—×©×•×‘</div>
        <div class="choice">××ª×’×¨ ××™× ×˜×œ×§×˜×•××œ×™ - ×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª ××•×¨×›×‘×•×ª</div>
        <div class="choice">×¢×‘×•×“×ª ×¦×•×•×ª - ×”×—×™×‘×•×¨ ×¢× ×”×× ×©×™×</div>
        <div class="choice">×”×ª×•×¦××” ×”×¡×•×¤×™×ª - ×œ×¨××•×ª ××ª ×”××•×¦×¨ ××•×›×Ÿ</div>
      </div>

      <button class="primary" type="button" onclick="next(4)">×”××©×š</button>
    </div>

    <!-- ×©×œ×‘ 4 -->
    <div class="card hidden" id="step4">
      <h2>×ª×§×©×•×¨×ª ×•×¤×ª×¨×•×Ÿ ×‘×¢×™×•×ª</h2>

      <label>×›×©×™×© ×“×“×œ×™×Ÿ ×§×¨×•×‘ ×•××ª ××¨×’×™×©×” ×œ×—×¥:</label>
      <div class="choice-group" data-field="pressureResponse">
        <div class="choice">×× ×™ ×¤×•×¢×œ×ª ×”×›×™ ×˜×•×‘ ×ª×—×ª ×œ×—×¥ - ×–×” ×× ×™×¢ ××•×ª×™</div>
        <div class="choice">×× ×™ ×¦×¨×™×›×” ×œ×ª×›× ×Ÿ ××¨××© ×›×“×™ ×œ×× ×•×¢ ×œ×—×¥</div>
        <div class="choice">×× ×™ ×œ×•×§×—×ª ×”×¤×¡×§×” ×§×¦×¨×” ×•××– ×—×•×–×¨×ª ×‘×›×•×—</div>
      </div>

      <label>×›×©×™×© ××™-×”×¡×›××” ×¢× ×”×©×•×ª×¤×” ×©×œ×š ×‘× ×•×©× ×—×©×•×‘:</label>
      <div class="choice-group" data-field="conflictStyle">
        <div class="choice">×¢×•×¦×¨×ª ×•×× ×¡×” ×œ×”×‘×™×Ÿ ×œ×¢×•××§ ××ª ×”×¦×“ ×”×©× ×™</div>
        <div class="choice">××¦×™×’×” ××ª ×”×¢××“×” ×©×œ×™ ×‘×‘×™×¨×•×¨ ×•×× ×¡×” ×œ×©×›× ×¢</div>
        <div class="choice">××—×¤×©×ª ×¤×©×¨×” ×©××©×œ×‘×ª ××ª ×©× ×™ ×”×¦×“×“×™×</div>
      </div>

      <label>××™×š ××ª ×”×›×™ × ×•×—×” ×œ×ª×§×©×¨ ×¢× ×”×©×•×ª×¤×” ×‘×™×Ÿ ×”××¤×’×©×™×?</label>
      <div class="choice-group" data-field="communicationStyle">
        <div class="choice">×¤×’×™×©×•×ª ×¤× ×™× ××œ ×¤× ×™× ×‘×œ×‘×“</div>
        <div class="choice">×©×™×—×•×ª ×•×™×“××• ××• ×˜×œ×¤×•×Ÿ</div>
        <div class="choice">×”×•×“×¢×•×ª ×˜×§×¡×˜ ×•×§×‘×¦×™× ××©×•×ª×¤×™×</div>
        <div class="choice">×œ× ××©× ×” ×œ×™ - ×× ×™ ×’××™×©×”</div>
      </div>

      <label>××™×–×” ×ª×•×›×Ÿ ×‘×××ª ××•×©×š ××•×ª×š ×‘×™×•×-×™×•×?</label>
      <div class="choice-group" data-field="lifeInterest">
        <div class="choice">×˜×›× ×•×œ×•×’×™×”, ××¤×œ×™×§×¦×™×•×ª ×•×—×“×©× ×•×ª</div>
        <div class="choice">×× ×©×™×, ×¤×¡×™×›×•×œ×•×’×™×” ×•×”×©×¤×¢×” ×—×‘×¨×ª×™×ª</div>
        <div class="choice">×¡×‘×™×‘×”, ×˜×‘×¢ ×•×§×™×™××•×ª</div>
        <div class="choice">×¨×¢×™×•× ×•×ª, ×¢×ª×™×“ ×•×ª×¨×‘×•×ª</div>
      </div>

      <button class="primary" type="button" onclick="next(5)">×”××©×š</button>
    </div>

    <!-- ×©×œ×‘ 5 -->
    <div class="card hidden" id="step5">
      <h2>×©××œ×” ××—×¨×•× ×”</h2>

      <label>×›××” ×—×©×•×‘ ×œ×š ×œ×”×ª××™× ×¢× ×”×©×•×ª×¤×” ×©×œ×š?</label>
      <div class="choice-group" data-field="importanceLevel">
        <div class="choice">×××•×“ ×—×©×•×‘ - ×× ×™ ×¨×•×¦×” ×”×ª×××” ×”×›×™ ×˜×•×‘×”</div>
        <div class="choice">×§×¦×ª ×—×©×•×‘ - ××‘×œ ×× ×™ ×™×›×•×œ×” ×œ×”×¡×ª×“×¨ ×¢× ×›×•×œ×Ÿ</div>
        <div class="choice">×œ× ×›×œ ×›×š ×—×©×•×‘ - ×× ×™ ×’××™×©×”</div>
      </div>

      <button class="primary" type="button" id="finishBtn" onclick="finish()">×¡×™×™××ª×™ - ××•×›× ×” ×œ×©×•×ª×¤×•×ª</button>
    </div>

    <!-- ××¡×š ×”××ª× ×” -->
    <div class="card hidden waiting-screen" id="waiting">
      <h2>×ª×•×“×” ×©×¡×™×™××ª! ğŸ‰</h2>
      <div class="spinner"></div>
      <p>×× ×—× ×• ×¢×•×‘×“×•×ª ×¢×œ ××¦×™××ª ×”×©×•×ª×¤×” ×”××•×©×œ××ª ×¢×‘×•×¨×š...</p>
      <p style="font-size: 15px; color: rgba(255,255,255,0.6); margin-top: 24px;">
        ×‘×¨×’×¢ ×©×›×œ ×”××©×ª×ª×¤×•×ª ×™×¡×™×™××•, × ×¦×™×’ ×›××Ÿ ××ª ×”×©×•×ª×¤×” ×©×œ×š.
      </p>
    </div>

    <!-- ××¡×š ×ª×•×¦××•×ª -->
    <div class="card hidden results-screen" id="results">
      <h2>×”×©×•×ª×¤×” ×©×œ×š ×œ××¡×¢! ğŸŒŸ</h2>
      <div id="partnerInfo"></div>
    </div>

  </div>

  <!-- Firebase SDK -->
  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, set, get, onValue, update } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    // TODO: ×”×—×œ×™×¤×™ ××ª ×”×§×•× ×¤×™×’×•×¨×¦×™×”
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    // ×§×‘×œ×ª ×§×•×“ ×”×¤×¢×™×œ×•×ª ××”-URL
    const urlParams = new URLSearchParams(window.location.search);
    const activityCode = urlParams.get('code') || 'default_activity';

    // ××©×ª× ×™× ×’×œ×•×‘×œ×™×™×
    let selections = {};
    let deviceId = localStorage.getItem('deviceId') || crypto.randomUUID();
    localStorage.setItem('deviceId', deviceId);

    // ×”×’×“×¨×ª ×‘×—×™×¨×•×ª
    document.querySelectorAll('.choice-group').forEach(group => {
      const field = group.dataset.field;
      group.querySelectorAll('.choice').forEach(choice => {
        choice.addEventListener('click', () => {
          group.querySelectorAll('.choice').forEach(c => c.classList.remove('selected'));
          choice.classList.add('selected');
          selections[field] = choice.textContent;
        });
      });
    });

    // × ×™×•×•×˜ ×‘×™×Ÿ ×©×œ×‘×™×
    window.next = (stepNum) => {
      // ×‘×“×™×§×ª ×ª×©×•×‘×•×ª ×œ×¤×™ ×©×œ×‘
      const validations = {
        2: ['mainDomain', 'secondDomain'],
        3: ['workStyle', 'teamStyle', 'workPace'],
        4: ['teamRole', 'motivationSource'],
        5: ['pressureResponse', 'conflictStyle', 'communicationStyle', 'lifeInterest']
      };

      const required = validations[stepNum];
      if (required && required.some(k => !selections[k])) {
        alert('× × ×œ×¢× ×•×ª ×¢×œ ×›×œ ×”×©××œ×•×ª ×œ×¤× ×™ ×”××©×š');
        return;
      }

      showStep(stepNum);
      updateProgress(stepNum);
    };

    function showStep(stepNum) {
      document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
      document.getElementById('step' + stepNum).classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    function updateProgress(stepNum) {
      const percentage = (stepNum / 5) * 100;
      document.getElementById('progressBar').style.width = percentage + '%';
      document.getElementById('progressText').textContent = `×©×œ×‘ ${stepNum} ××ª×•×š 5`;
    }

    // ×¡×™×•× ×”×©××œ×•×Ÿ
    window.finish = async () => {
      const displayName = document.getElementById('displayName').value.trim();
      
      if (!displayName) {
        alert('×›×ª×‘×™ ×©× ×¤×¨×˜×™/×›×™× ×•×™ ×›×“×™ ×©×ª×•×›×œ×™ ×œ×–×”×•×ª ××ª ×¢×¦××š ×‘××¡×š ×”×—×™×‘×•×¨×™×.');
        return;
      }

      const required = [
        'mainDomain', 'secondDomain', 'workStyle', 'teamStyle', 'workPace',
        'teamRole', 'motivationSource', 'pressureResponse', 'conflictStyle',
        'communicationStyle', 'lifeInterest', 'importanceLevel'
      ];
      
      if (required.some(k => !selections[k])) {
        alert('× × ×œ×¢× ×•×ª ×¢×œ ×›×œ ×”×©××œ×•×ª ×œ×¤× ×™ ×¡×™×•×.');
        return;
      }

      document.getElementById('finishBtn').disabled = true;
      document.getElementById('finishBtn').textContent = '×©×•×œ×—...';

      try {
        // ×©××™×¨×ª ×”×ª×©×•×‘×•×ª
        const responseId = crypto.randomUUID();
        const responseRef = ref(database, `responses/${activityCode}/${responseId}`);
        
        await set(responseRef, {
          deviceId,
          displayName,
          ...selections,
          createdAt: Date.now()
        });

        // ×¢×“×›×•×Ÿ ××¡×¤×¨ ×”×©××œ×•× ×™× ×©×”×•×©×œ××•
        const activityRef = ref(database, `activities/${activityCode}`);
        const snapshot = await get(activityRef);
        
        if (snapshot.exists()) {
          const data = snapshot.val();
          await update(activityRef, {
            completedCount: (data.completedCount || 0) + 1
          });
        }

        // ××¢×‘×¨ ×œ××¡×š ×”××ª× ×”
        showStep('waiting');
        document.querySelector('.progress-bar-container').style.display = 'none';
        document.querySelector('.progress-text').style.display = 'none';

        // ×”××–× ×” ×œ×ª×•×¦××•×ª
        listenForResults();

      } catch (error) {
        console.error('Error:', error);
        alert('××™×¨×¢×” ×©×’×™××”. × ×¡×™ ×©×•×‘.');
        document.getElementById('finishBtn').disabled = false;
        document.getElementById('finishBtn').textContent = '×¡×™×™××ª×™ - ××•×›× ×” ×œ×©×•×ª×¤×•×ª';
      }
    };

    function showStep(stepId) {
      document.querySelectorAll('.card').forEach(card => card.classList.add('hidden'));
      document.getElementById(stepId).classList.remove('hidden');
      window.scrollTo({ top: 0, behavior: 'smooth' });
    }

    // ×”××–× ×” ×œ×ª×•×¦××•×ª ×–×™×•×•×’
    function listenForResults() {
      const pairingsRef = ref(database, `pairings/${activityCode}`);
      
      onValue(pairingsRef, (snapshot) => {
        if (snapshot.exists()) {
          const pairings = snapshot.val();
          const myPairing = Object.values(pairings).find(p => 
            p.deviceIds && p.deviceIds.includes(deviceId)
          );
          
          if (myPairing) {
            displayResults(myPairing);
          }
        }
      });
    }

    function displayResults(pairing) {
      const partnerInfo = document.getElementById('partnerInfo');
      
      let html = '';
      
      if (pairing.type === 'pair') {
        const partner = pairing.members.find(m => m.deviceId !== deviceId);
        html = `
          <div class="partner-card">
            <div class="partner-name">${partner.displayName}</div>
            <div class="match-score">×”×ª×××”: ${pairing.score}%</div>
            ${pairing.reasons ? `
              <ul class="match-reasons">
                ${pairing.reasons.slice(0, 3).map(r => `<li>${r}</li>`).join('')}
              </ul>
            ` : ''}
          </div>
          <p style="text-align:center; margin-top:20px; color:rgba(255,255,255,0.7);">
            ××–×œ ×˜×•×‘! ×”×ª×—×™×œ×• ×œ×¢×‘×•×“ ×‘×™×—×“ ğŸ’ª
          </p>
        `;
      } else if (pairing.type === 'trio') {
        html = `
          <div class="partner-card">
            <div class="partner-name">×§×‘×•×¦×ª ×©×œ×™×©×™×™×”</div>
            <p style="margin-top:12px; line-height:1.6;">
              × ×•×¦×¨×” ×§×‘×•×¦×” ×©×œ 3 ××©×ª×ª×¤×•×ª:
            </p>
            <ul style="margin-top:16px;">
              ${pairing.members.map(m => `<li style="padding:8px 0;">${m.displayName}</li>`).join('')}
            </ul>
          </div>
          <p style="text-align:center; margin-top:20px; color:rgba(255,255,255,0.7);">
            ×©×œ×•×© ×–×” ×›×•×—! ×‘×”×¦×œ×—×” ğŸ’ª
          </p>
        `;
      }
      
      partnerInfo.innerHTML = html;
      showStep('results');
    }

    // ×”×ª×—×œ×” - ×”×¦×’×ª ×©×œ×‘ 1
    updateProgress(1);
  </script>

</body>
</html>
