<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>×× ×•×¢ ×–×™×•×•×’ | ×¤×•×¨×¦×•×ª ×“×¨×š</title>
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #000000;
      color: #ffffff;
      min-height: 100vh;
      padding: 40px 20px;
    }
    
    .container {
      max-width: 900px;
      margin: 0 auto;
    }
    
    h1 {
      font-size: 32px;
      text-align: center;
      margin-bottom: 40px;
      background: linear-gradient(135deg, #ff1493, #ff69b4);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    
    .btn {
      width: 100%;
      padding: 18px;
      font-size: 18px;
      font-weight: 700;
      background: linear-gradient(135deg, #ff1493, #ff69b4);
      color: white;
      border: none;
      border-radius: 14px;
      cursor: pointer;
      margin-bottom: 32px;
    }
    
    .btn:hover {
      transform: translateY(-2px);
      box-shadow: 0 8px 25px rgba(255, 20, 147, 0.6);
    }
    
    .status {
      text-align: center;
      padding: 16px;
      border-radius: 12px;
      margin-bottom: 24px;
      background: rgba(76, 175, 80, 0.2);
      border: 1px solid rgba(76, 175, 80, 0.4);
    }
    
    .pairs-container {
      display: grid;
      gap: 20px;
    }
    
    .pair-card {
      background: rgba(30, 30, 35, 0.95);
      border: 1px solid rgba(255, 20, 147, 0.3);
      border-radius: 16px;
      padding: 24px;
    }
    
    .pair-header {
      font-size: 20px;
      font-weight: 700;
      color: #ff69b4;
      margin-bottom: 12px;
    }
    
    .pair-members {
      font-size: 18px;
      margin-bottom: 8px;
    }
    
    .pair-score {
      color: rgba(255, 255, 255, 0.7);
      font-size: 16px;
    }
  </style>
</head>

<body>

  <div class="container">
    <h1>ğŸ”— ×× ×•×¢ ×–×™×•×•×’ ××•×˜×•××˜×™</h1>
    
    <button class="btn" onclick="runMatching()">ğŸš€ ×”×¨×¥ ×—×™×©×•×‘ ×–×™×•×•×’</button>
    
    <div id="status"></div>
    <div id="results" class="pairs-container"></div>
  </div>

  <script type="module">
    import { initializeApp } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js';
    import { getDatabase, ref, get, set } from 'https://www.gstatic.com/firebasejs/10.7.1/firebase-database.js';

    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      databaseURL: "YOUR_DATABASE_URL",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID"
    };

    const app = initializeApp(firebaseConfig);
    const database = getDatabase(app);

    const urlParams = new URLSearchParams(window.location.search);
    const activityCode = urlParams.get('code') || 'default_activity';

    // ========================================
    // ××œ×’×•×¨×™×ª× × ×™×§×•×“ ××©×•×¤×¨ (××”×§×•×“ ×©×œ×š)
    // ========================================

    function calculateScore(a, b) {
      let score = 0;
      let reasons = [];

      // ×ª×—×•××™ ×¢× ×™×™×Ÿ (30 × ×§×•×“×•×ª ××§×¡)
      if (a.mainDomain === b.mainDomain) {
        score += 15;
        reasons.push(`×©×ª×™×›×Ÿ ×‘×—×¨×ª×Ÿ ×‘${a.mainDomain} ×›×ª×—×•× ×¢×™×§×¨×™`);
      }
      
      if (a.mainDomain === b.secondDomain && b.secondDomain !== "×× ×™ ××¢×“×™×¤×” ×œ×”×ª××§×“ ×‘×ª×—×•× ××—×“") {
        score += 8;
        reasons.push(`${b.displayName} ××ª×¢× ×™×™× ×ª ×’× ×‘${a.mainDomain}`);
      }
      if (b.mainDomain === a.secondDomain && a.secondDomain !== "×× ×™ ××¢×“×™×¤×” ×œ×”×ª××§×“ ×‘×ª×—×•× ××—×“") {
        score += 8;
        reasons.push(`${a.displayName} ××ª×¢× ×™×™× ×ª ×’× ×‘${b.mainDomain}`);
      }
      
      if (a.secondDomain === b.secondDomain && 
          a.secondDomain !== "×× ×™ ××¢×“×™×¤×” ×œ×”×ª××§×“ ×‘×ª×—×•× ××—×“") {
        score += 5;
      }
      
      if (a.secondDomain === "×× ×™ ××¢×“×™×¤×” ×œ×”×ª××§×“ ×‘×ª×—×•× ××—×“" && 
          b.secondDomain === "×× ×™ ××¢×“×™×¤×” ×œ×”×ª××§×“ ×‘×ª×—×•× ××—×“") {
        score += 3;
      }

      // ×¡×’× ×•×Ÿ ×¢×‘×•×“×” (25 × ×§×•×“×•×ª ××§×¡)
      if (a.workStyle !== b.workStyle) {
        score += 8;
        reasons.push('×¡×’× ×•× ×•×ª ×¢×‘×•×“×” ××©×œ×™××™×');
      } else {
        score += 2;
      }
      
      if (a.teamStyle !== b.teamStyle) {
        score += 7;
        reasons.push('××™×–×•×Ÿ ××¦×•×™×Ÿ ×‘×ª×§×©×•×¨×ª');
      } else {
        score += 3;
      }
      
      if (a.workPace === b.workPace && a.workPace !== "×ª×œ×•×™ ×‘××©×™××” - ×× ×™ ×’××™×©×”") {
        score += 5;
      } else if (a.workPace === "×ª×œ×•×™ ×‘××©×™××” - ×× ×™ ×’××™×©×”" || 
                 b.workPace === "×ª×œ×•×™ ×‘××©×™××” - ×× ×™ ×’××™×©×”") {
        if (a.workPace === "×ª×œ×•×™ ×‘××©×™××” - ×× ×™ ×’××™×©×”" && 
            b.workPace === "×ª×œ×•×™ ×‘××©×™××” - ×× ×™ ×’××™×©×”") {
          score += 8;
          reasons.push('×©×ª×™×›×Ÿ ×’××™×©×•×ª ×‘×§×¦×‘');
        } else {
          score += 6;
        }
      } else if ((a.workPace === "×× ×™ ××•×”×‘×ª ×œ×¢×‘×•×“ ××”×¨ ×•×œ×¡×™×™× ××•×§×“×" && 
                  b.workPace === "×× ×™ ××¢×“×™×¤×” ×œ×§×—×ª ×–××Ÿ ×•×œ×¢×©×•×ª ×‘×“×™×•×§") ||
                 (b.workPace === "×× ×™ ××•×”×‘×ª ×œ×¢×‘×•×“ ××”×¨ ×•×œ×¡×™×™× ××•×§×“×" && 
                  a.workPace === "×× ×™ ××¢×“×™×¤×” ×œ×§×—×ª ×–××Ÿ ×•×œ×¢×©×•×ª ×‘×“×™×•×§")) {
        score -= 3;
      }

      // ×ª×¤×§×™×“ ×‘×¦×•×•×ª (20 × ×§×•×“×•×ª ××§×¡)
      if (a.teamRole !== b.teamRole) {
        score += 7;
        
        if ((a.teamRole === "×œ××¦×•× ×¨×¢×™×•× ×•×ª ××§×•×¨×™×™× ×•×œ×”×ª×—×™×œ ×“×‘×¨×™× ×—×“×©×™×" && 
             b.teamRole === "×œ××¨×’×Ÿ ××©×™××•×ª ×•×œ×•×•×“× ×©×”×›×œ ×–×•×¨× ×‘×–××Ÿ") ||
            (b.teamRole === "×œ××¦×•× ×¨×¢×™×•× ×•×ª ××§×•×¨×™×™× ×•×œ×”×ª×—×™×œ ×“×‘×¨×™× ×—×“×©×™×" && 
             a.teamRole === "×œ××¨×’×Ÿ ××©×™××•×ª ×•×œ×•×•×“× ×©×”×›×œ ×–×•×¨× ×‘×–××Ÿ")) {
          score += 2;
          reasons.push('×§×•××‘×• ××•×©×œ×: ×¨×¢×™×•× ×•×ª + ××¨×’×•×Ÿ');
        }
      } else {
        score += 2;
      }
      
      if (a.motivationSource === b.motivationSource) {
        score += 6;
        reasons.push('××•×ª×” ××•×˜×™×‘×¦×™×”');
      } else {
        score += 3;
      }

      // ×ª×§×©×•×¨×ª ×•××ª×— (25 × ×§×•×“×•×ª ××§×¡)
      if ((a.pressureResponse === "×× ×™ ×¤×•×¢×œ×ª ×”×›×™ ×˜×•×‘ ×ª×—×ª ×œ×—×¥ - ×–×” ×× ×™×¢ ××•×ª×™" && 
           b.pressureResponse === "×× ×™ ×¦×¨×™×›×” ×œ×ª×›× ×Ÿ ××¨××© ×›×“×™ ×œ×× ×•×¢ ×œ×—×¥") ||
          (b.pressureResponse === "×× ×™ ×¤×•×¢×œ×ª ×”×›×™ ×˜×•×‘ ×ª×—×ª ×œ×—×¥ - ×–×” ×× ×™×¢ ××•×ª×™" && 
           a.pressureResponse === "×× ×™ ×¦×¨×™×›×” ×œ×ª×›× ×Ÿ ××¨××© ×›×“×™ ×œ×× ×•×¢ ×œ×—×¥")) {
        score += 9;
        reasons.push('××™×–×•×Ÿ ××•×©×œ× ×‘× ×™×”×•×œ ×œ×—×¥');
      } else if ((a.pressureResponse === "×× ×™ ×¤×•×¢×œ×ª ×”×›×™ ×˜×•×‘ ×ª×—×ª ×œ×—×¥ - ×–×” ×× ×™×¢ ××•×ª×™" && 
                  b.pressureResponse === "×× ×™ ×œ×•×§×—×ª ×”×¤×¡×§×” ×§×¦×¨×” ×•××– ×—×•×–×¨×ª ×‘×›×•×—") ||
                 (b.pressureResponse === "×× ×™ ×¤×•×¢×œ×ª ×”×›×™ ×˜×•×‘ ×ª×—×ª ×œ×—×¥ - ×–×” ×× ×™×¢ ××•×ª×™" && 
                  a.pressureResponse === "×× ×™ ×œ×•×§×—×ª ×”×¤×¡×§×” ×§×¦×¨×” ×•××– ×—×•×–×¨×ª ×‘×›×•×—")) {
        score += 6;
      } else {
        score += 4;
      }
      
      if ((a.conflictStyle === "×¢×•×¦×¨×ª ×•×× ×¡×” ×œ×”×‘×™×Ÿ ×œ×¢×•××§ ××ª ×”×¦×“ ×”×©× ×™" && 
           b.conflictStyle === "××¦×™×’×” ××ª ×”×¢××“×” ×©×œ×™ ×‘×‘×™×¨×•×¨ ×•×× ×¡×” ×œ×©×›× ×¢") ||
          (b.conflictStyle === "×¢×•×¦×¨×ª ×•×× ×¡×” ×œ×”×‘×™×Ÿ ×œ×¢×•××§ ××ª ×”×¦×“ ×”×©× ×™" && 
           a.conflictStyle === "××¦×™×’×” ××ª ×”×¢××“×” ×©×œ×™ ×‘×‘×™×¨×•×¨ ×•×× ×¡×” ×œ×©×›× ×¢")) {
        score += 8;
        reasons.push('×©×™×œ×•×‘: ××—×ª ××§×©×™×‘×” ×•××—×ª ××•×‘×™×œ×”');
      } else if (a.conflictStyle === "××—×¤×©×ª ×¤×©×¨×” ×©××©×œ×‘×ª ××ª ×©× ×™ ×”×¦×“×“×™×" || 
                 b.conflictStyle === "××—×¤×©×ª ×¤×©×¨×” ×©××©×œ×‘×ª ××ª ×©× ×™ ×”×¦×“×“×™×") {
        if (a.conflictStyle === b.conflictStyle) {
          score += 9;
          reasons.push('×©×ª×™×›×Ÿ ××—×¤×©×•×ª ×¤×©×¨×•×ª');
        } else {
          score += 7;
        }
      } else {
        score += 5;
      }
      
      if (a.communicationStyle === b.communicationStyle && 
          a.communicationStyle !== "×œ× ××©× ×” ×œ×™ - ×× ×™ ×’××™×©×”") {
        score += 8;
        reasons.push('××•×ª×• ×¡×’× ×•×Ÿ ×ª×§×©×•×¨×ª');
      } else if (a.communicationStyle === "×œ× ××©× ×” ×œ×™ - ×× ×™ ×’××™×©×”" || 
                 b.communicationStyle === "×œ× ××©× ×” ×œ×™ - ×× ×™ ×’××™×©×”") {
        score += 7;
      } else {
        score += 2;
      }

      // ×ª×—×•××™ ×¢× ×™×™×Ÿ ××™×©×™×™× (10 × ×§×•×“×•×ª ××§×¡)
      if (a.lifeInterest === b.lifeInterest) {
        score += 4;
      } else {
        score += 1;
      }

      // ×›×¤×œ ×œ×¤×™ ×—×©×™×‘×•×ª
      let multiplier = 1;
      if (a.importanceLevel === "×××•×“ ×—×©×•×‘ - ×× ×™ ×¨×•×¦×” ×”×ª×××” ×”×›×™ ×˜×•×‘×”" ||
          b.importanceLevel === "×××•×“ ×—×©×•×‘ - ×× ×™ ×¨×•×¦×” ×”×ª×××” ×”×›×™ ×˜×•×‘×”") {
        multiplier = 1.3;
      }
      
      score = score * multiplier;

      // ×¨×¢×© ×œ×©×‘×™×¨×ª ×©×•×•×™×•×Ÿ
      const nameKey = (a.displayName + '|' + b.displayName)
        .split('')
        .reduce((acc, ch) => acc + ch.charCodeAt(0), 0);
      score += (nameKey % 7) * 0.01;

      return { score: Math.round(score * 100) / 100, reasons };
    }

    // ========================================
    // ×¤×•× ×§×¦×™×” ×œ×‘×—×™×¨×ª ×–×•×’×•×ª ××•×¤×˜×™××œ×™×™×
    // ========================================

    function pickBestPairs(students) {
      const n = students.length;
      
      function greedyPairing() {
        let available = [...students];
        let pairs = [];
        
        while (available.length > 1) {
          let bestPair = { i: -1, j: -1, scoreData: { score: -Infinity } };
          
          for (let i = 0; i < available.length; i++) {
            for (let j = i + 1; j < available.length; j++) {
              const scoreData = calculateScore(available[i], available[j]);
              if (scoreData.score > bestPair.scoreData.score) {
                bestPair = { i, j, scoreData };
              }
            }
          }
          
          if (bestPair.i !== -1) {
            pairs.push({
              a: available[bestPair.i],
              b: available[bestPair.j],
              scoreData: bestPair.scoreData
            });
            
            available = available.filter((_, idx) => 
              idx !== bestPair.i && idx !== bestPair.j
            );
          }
        }
        
        return { pairs, remaining: available };
      }

      const result = greedyPairing();
      let pairs = result.pairs;
      let trio = null;

      // ×˜×™×¤×•×œ ×‘××¡×¤×¨ ××™-×–×•×’×™
      if (result.remaining.length === 1 && pairs.length > 0) {
        const lone = result.remaining[0];
        let bestTrioIdx = 0;
        let bestTrioScore = -Infinity;
        
        for (let k = 0; k < pairs.length; k++) {
          const score1 = calculateScore(lone, pairs[k].a).score;
          const score2 = calculateScore(lone, pairs[k].b).score;
          const totalScore = score1 + score2;
          
          if (totalScore > bestTrioScore) {
            bestTrioScore = totalScore;
            bestTrioIdx = k;
          }
        }
        
        trio = {
          lone,
          withPairIndex: bestTrioIdx
        };
      }

      return { pairs, trio };
    }

    // ========================================
    // ×”×¨×¦×ª ×”×–×™×•×•×’
    // ========================================

    window.runMatching = async () => {
      const statusDiv = document.getElementById('status');
      const resultsDiv = document.getElementById('results');
      
      statusDiv.innerHTML = 'â³ ×˜×•×¢×Ÿ ×ª×©×•×‘×•×ª...';
      resultsDiv.innerHTML = '';

      try {
        // ×©×œ×™×¤×ª ×ª×©×•×‘×•×ª
        const responsesRef = ref(database, `responses/${activityCode}`);
        const snapshot = await get(responsesRef);
        
        if (!snapshot.exists()) {
          statusDiv.innerHTML = 'âŒ ××™×Ÿ ×ª×©×•×‘×•×ª ×¢×“×™×™×Ÿ';
          return;
        }

        const responses = Object.entries(snapshot.val()).map(([id, data]) => ({
          id,
          ...data
        }));

        statusDiv.innerHTML = `ğŸ”„ ××—×©×‘ ×–×™×•×•×’ ×¢×‘×•×¨ ${responses.length} ××©×ª×ª×¤×•×ª...`;

        // ×—×™×©×•×‘ ×–×™×•×•×’
        const { pairs, trio } = pickBestPairs(responses);

        // ×©××™×¨×ª ×”×–×™×•×•×’
        const pairingsRef = ref(database, `pairings/${activityCode}`);
        const pairingsData = {};

        pairs.forEach((pair, index) => {
          const pairId = `pair_${index + 1}`;
          pairingsData[pairId] = {
            type: 'pair',
            members: [
              { displayName: pair.a.displayName, deviceId: pair.a.deviceId },
              { displayName: pair.b.displayName, deviceId: pair.b.deviceId }
            ],
            deviceIds: [pair.a.deviceId, pair.b.deviceId],
            score: Math.round(pair.scoreData.score),
            reasons: pair.scoreData.reasons
          };
        });

        if (trio) {
          const trioId = `trio_1`;
          const pairMembers = pairs[trio.withPairIndex];
          pairingsData[trioId] = {
            type: 'trio',
            members: [
              { displayName: trio.lone.displayName, deviceId: trio.lone.deviceId },
              { displayName: pairMembers.a.displayName, deviceId: pairMembers.a.deviceId },
              { displayName: pairMembers.b.displayName, deviceId: pairMembers.b.deviceId }
            ],
            deviceIds: [trio.lone.deviceId, pairMembers.a.deviceId, pairMembers.b.deviceId]
          };
        }

        await set(pairingsRef, pairingsData);

        // ×”×¦×’×ª ×ª×•×¦××•×ª
        statusDiv.innerHTML = `âœ… ×–×™×•×•×’ ×”×•×©×œ×! × ×•×¦×¨×• ${pairs.length} ×–×•×’×•×ª${trio ? ' ×•×©×œ×™×©×™×™×” ××—×ª' : ''}`;
        
        let html = '';
        pairs.forEach((pair, index) => {
          html += `
            <div class="pair-card">
              <div class="pair-header">×–×•×’ ${index + 1}</div>
              <div class="pair-members">${pair.a.displayName} â¤ï¸ ${pair.b.displayName}</div>
              <div class="pair-score">×¦×™×•×Ÿ ×”×ª×××”: ${Math.round(pair.scoreData.score)}</div>
            </div>
          `;
        });

        if (trio) {
          const pairMembers = pairs[trio.withPairIndex];
          html += `
            <div class="pair-card" style="border-color: #ffd700;">
              <div class="pair-header">×©×œ×™×©×™×™×” ××™×•×—×“×ª â­</div>
              <div class="pair-members">
                ${trio.lone.displayName}, ${pairMembers.a.displayName}, ${pairMembers.b.displayName}
              </div>
            </div>
          `;
        }

        resultsDiv.innerHTML = html;

      } catch (error) {
        console.error('Error:', error);
        statusDiv.innerHTML = 'âŒ ×©×’×™××” ×‘×—×™×©×•×‘ ×”×–×™×•×•×’';
      }
    };
  </script>

</body>
</html>
